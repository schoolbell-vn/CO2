<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Environment STEM</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { background-color: #f0f4f8; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        
        .app-container {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            background: white; box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 20px 50px 20px; color: white;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
        }

        /* CO2 GAUGE (Nổi bật) */
        .main-card {
            background: white; margin: -40px 20px 15px 20px;
            border-radius: 20px; padding: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); text-align: center;
        }
        .co2-circle {
            width: 140px; height: 140px; border-radius: 50%;
            background: conic-gradient(#00ba94 0%, #eee 0%);
            margin: 0 auto 10px auto;
            display: flex; align-items: center; justify-content: center;
        }
        .co2-inner {
            width: 115px; height: 115px; background: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* CARDS NHIỆT ĐỘ & ĐỘ ẨM (2 cột) */
        .sensor-row { display: flex; gap: 15px; padding: 0 20px 20px 20px; }
        .sensor-card {
            flex: 1; background: #f8f9fa; border-radius: 15px;
            padding: 15px; text-align: center; border: 1px solid #eee;
            transition: transform 0.2s;
        }
        .sensor-card:active { transform: scale(0.95); }
        .sensor-icon { font-size: 1.5rem; margin-bottom: 5px; }
        .sensor-val { font-size: 1.5rem; font-weight: 800; color: #333; }
        .sensor-label { font-size: 0.8rem; color: #666; text-transform: uppercase; }

        /* Nút chuyển chế độ */
        .mode-switch {
            background: #e9ecef; border-radius: 12px; padding: 4px;
            margin: 0 20px 20px 20px; display: flex;
        }
        .mode-btn {
            flex: 1; border: none; background: transparent; padding: 10px;
            border-radius: 10px; font-size: 13px; font-weight: 600; color: #666;
        }
        .mode-btn.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Control Panels */
        .panel { display: none; padding: 0 20px; animation: fadeUp 0.3s; }
        .panel.show { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Big Button */
        .btn-big {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 16px; margin-bottom: 10px;
            color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-on { background: #ff4757; }
        .btn-off { background: #2f3542; }

    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="d-flex justify-content-between">
            <div><h5 class="fw-bold m-0">Environment Monitor</h5><small>STEM Lab Project</small></div>
            <div class="badge bg-white text-dark bg-opacity-25"><i class="fas fa-wifi me-1"></i><span id="conn-text">Offline</span></div>
        </div>
    </div>

    <div class="main-card">
        <div class="co2-circle" id="gauge-co2">
            <div class="co2-inner">
                <span id="val-co2" style="font-size: 2rem; font-weight:800">--</span>
                <span style="font-size: 0.7rem; color:#888">PPM CO2</span>
            </div>
        </div>
        <div id="status-co2" class="fw-bold text-success small">Đang kết nối...</div>
    </div>

    <div class="sensor-row">
        <div class="sensor-card">
            <div class="sensor-icon text-danger"><i class="fas fa-temperature-high"></i></div>
            <div class="sensor-val"><span id="val-temp">--</span>°C</div>
            <div class="sensor-label">Nhiệt độ</div>
        </div>
        <div class="sensor-card">
            <div class="sensor-icon text-primary"><i class="fas fa-tint"></i></div>
            <div class="sensor-val"><span id="val-hum">--</span>%</div>
            <div class="sensor-label">Độ ẩm</div>
        </div>
    </div>

    <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('AUTO', this)">Tự động</button>
        <button class="mode-btn" onclick="setMode('MANUAL', this)">Thủ công</button>
    </div>

    <div id="p-AUTO" class="panel show text-center">
        <div class="bg-white p-3 rounded-3 border">
            <i class="fas fa-magic text-warning fa-2x mb-2"></i>
            <p class="small text-muted mb-0">Quạt sẽ bật nếu:<br><b>CO2 > 1000 ppm</b> hoặc <b>Độ ẩm > 80%</b></p>
        </div>
    </div>

    <div id="p-MANUAL" class="panel">
        <button class="btn-big btn-on" onclick="sendFan('1')">BẬT QUẠT</button>
        <button class="btn-big btn-off" onclick="sendFan('0')">TẮT QUẠT</button>
    </div>

</div>

<script>
    // --- CẤU HÌNH MQTT ---
    const config = {
        host: "8bdef73996bb4030affe9483eecde31b.s1.eu.hivemq.cloud",
        port: 8884, user: "ngoctuyka", pass: "Tu12345678@", useSSL: true
    };
    const prefix = "stem_thpt_physics_project_2025";
    const topics = {
        co2: prefix + "/data/co2",
        temp: prefix + "/data/temp", // Topic mới cho Nhiệt độ
        hum: prefix + "/data/hum",   // Topic mới cho Độ ẩm
        mode: prefix + "/control/mode",
        fan: prefix + "/control/fan"
    };

    const client = new Paho.MQTT.Client(config.host, config.port, "App-" + parseInt(Math.random()*10000));

    // --- LOGIC GIAO DIỆN ---
    function setMode(mode, btn) {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.getElementById('p-' + mode).classList.add('show');

        // Gửi lệnh: 1=Auto, 0=Manual
        sendMQTT(topics.mode, (mode === 'AUTO' ? "1" : "0"));
    }

    function sendFan(state) {
        sendMQTT(topics.fan, state);
    }

    function updateGauge(id, val, max, color) {
        document.getElementById("val-" + id).innerText = val;
        if(id === 'co2') {
            let pct = (val/max)*100;
            document.getElementById("gauge-co2").style.background = `conic-gradient(${color} ${pct}%, #eee ${pct}%)`;
            
            let status = "Không khí Tốt";
            if(val > 1000) status = "Cảnh báo nhẹ";
            if(val > 2000) status = "NGUY HIỂM";
            document.getElementById("status-co2").innerText = status;
            document.getElementById("status-co2").style.color = color;
        }
    }

    // --- MQTT HANDLERS ---
    client.onConnectionLost = (obj) => {
        console.log("Mất kết nối");
        document.getElementById("conn-text").innerText = "Offline";
    };

    client.onMessageArrived = (msg) => {
        const payload = msg.payloadString;
        const topic = msg.destinationName;

        if(topic === topics.co2) {
            let val = parseInt(payload);
            let color = (val > 1000) ? "#ffc107" : "#28a745";
            if(val > 2000) color = "#dc3545";
            updateGauge('co2', val, 5000, color);
        }
        else if (topic === topics.temp) {
            document.getElementById("val-temp").innerText = payload;
        }
        else if (topic === topics.hum) {
            document.getElementById("val-hum").innerText = payload;
        }
    };

    function connect() {
        client.connect({
            onSuccess: () => {
                console.log("Đã kết nối");
                document.getElementById("conn-text").innerText = "Online";
                // Đăng ký nhận cả 3 topic
                client.subscribe(topics.co2);
                client.subscribe(topics.temp);
                client.subscribe(topics.hum);
            },
            onFailure: (e) => { console.log("Lỗi: " + e.errorMessage); },
            useSSL: config.useSSL, userName: config.user, password: config.pass
        });
    }
    
    function sendMQTT(topic, msg) {
        if(client.isConnected()) {
            let m = new Paho.MQTT.Message(msg);
            m.destinationName = topic; m.retained = true;
            client.send(m);
        }
    }

    connect();
</script>

</body>
</html>
