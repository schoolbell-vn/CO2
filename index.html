<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Classroom v3</title>
    <!-- Kiểm tra đăng nhập -->
    <script>if(sessionStorage.getItem('isLoggedIn')!=='true')window.location.href='login.html';</script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: -apple-system, sans-serif; padding-bottom: 50px; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: #fff; }
        .header { background: linear-gradient(135deg, #0d6efd, #0dcaf0); padding: 20px 20px 40px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        
        .gauge-card { background: white; margin: -30px 15px 15px; border-radius: 20px; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; }
        .co2-circle { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#20c997 0%, #eee 0%); margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; }
        .co2-inner { width: 100px; height: 100px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; }
        
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 15px; margin-bottom: 15px; }
        .s-card { background: #f8f9fa; padding: 12px; border-radius: 12px; text-align: center; border: 1px solid #e9ecef; }
        .s-val { font-size: 1.2rem; font-weight: 800; color: #333; }
        
        .presence-card { margin: 0 15px 15px; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; font-weight: bold; }
        .has-person { background: #d1e7dd; color: #0f5132; border: 1px solid #a3cfbb; }
        .no-person { background: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }

        .control-area { padding: 0 15px; }
        .mode-sw { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .mode-btn { flex: 1; border: none; background: none; padding: 10px; border-radius: 8px; font-weight: 600; color: #666; }
        .mode-btn.active { background: white; color: #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .device-box { border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .device-title { font-weight: bold; font-size: 1rem; margin-bottom: 10px; color: #444; display: block; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        
        /* STYLE MỚI CHO NÚT BẤM CÓ PHẢN HỒI */
        .btn-control {
            width: 100%; padding: 12px; border-radius: 8px; border: 2px solid transparent;
            font-weight: bold; color: #555; background-color: #f1f3f5;
            transition: all 0.2s;
        }
        /* Trạng thái nút khi được chọn (Active) */
        .btn-control.active-on {
            background-color: #198754; color: white; border-color: #146c43;
            box-shadow: 0 0 8px rgba(25, 135, 84, 0.4);
        }
        .btn-control.active-off {
            background-color: #6c757d; color: white; border-color: #565e64;
            box-shadow: 0 0 8px rgba(108, 117, 125, 0.4);
        }
        /* Hiệu ứng khi bấm */
        .btn-control:active { transform: scale(0.96); }

        .panel { display: none; } .panel.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
        
        .status-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; min-width: 60px; }
        .st-on { background: #d1e7dd; color: #0f5132; }
        .st-off { background: #f8d7da; color: #842029; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header d-flex justify-content-between align-items-center">
        <div><h5 class="m-0 fw-bold">LỚP HỌC THÔNG MINH</h5><small>Giám sát & Điều khiển</small></div>
        <button onclick="logout()" class="btn btn-sm btn-light text-primary rounded-circle"><i class="fas fa-sign-out-alt"></i></button>
    </div>

    <!-- CO2 -->
    <div class="gauge-card">
        <div class="co2-circle" id="g-co2"><div class="co2-inner"><span id="v-co2" style="font-size:1.8rem; font-weight:bold">--</span><span style="font-size:0.7rem">PPM</span></div></div>
        <div id="st-co2" class="fw-bold text-success small">Đang kết nối...</div>
    </div>

    <!-- SENSORS -->
    <div class="sensor-grid">
        <div class="s-card"><i class="fas fa-temperature-high text-danger"></i> <span id="v-temp" class="s-val">--</span>°C</div>
        <div class="s-card"><i class="fas fa-tint text-primary"></i> <span id="v-hum" class="s-val">--</span>%</div>
        <div class="s-card" style="grid-column: span 2;">
            <div class="d-flex justify-content-between px-3">
                <span><i class="fas fa-smog text-secondary"></i> Bụi PM2.5:</span>
                <span><span id="v-dust" class="s-val">--</span> µg/m³</span>
            </div>
        </div>
    </div>

    <!-- PRESENCE -->
    <div class="presence-card no-person" id="card-occ">
        <div><i class="fas fa-user-friends me-2"></i>Hiện diện:</div>
        <span id="txt-occ">VẮNG</span>
    </div>

    <!-- CONTROL -->
    <div class="control-area">
        <div class="mode-sw">
            <button class="mode-btn active" onclick="setMode('AUTO', this)">TỰ ĐỘNG</button>
            <button class="mode-btn" onclick="setMode('MANUAL', this)">THỦ CÔNG</button>
        </div>

        <!-- PANEL AUTO -->
        <div id="p-AUTO" class="panel show">
            <div class="alert alert-primary border-0 small mb-3">
                <i class="fas fa-magic me-1"></i> <strong>Nguyên lý hoạt động:</strong><br>
                - <b>Vắng người:</b> TẮT HẾT.<br>
                - <b>Có người:</b> Đèn bật. Quạt hút bật khi khí bẩn. Quạt trần chạy theo ý muốn (nhớ trạng thái).
            </div>
            
            <div class="d-flex justify-content-between text-center small bg-light p-2 rounded mb-3">
                <div class="px-1">Q.Trần<br><b id="st-ceil">--</b></div>
                <div class="px-1" style="border-left:1px solid #ddd; border-right:1px solid #ddd">Q.Hút<br><b id="st-exh">--</b></div>
                <div class="px-1">Đèn<br><b id="st-light">--</b></div>
            </div>

            <!-- Nút chỉnh Quạt trần trong Auto -->
            <div class="device-box">
                <small class="text-muted d-block mb-1 text-center fw-bold">Điều khiển Quạt Trần (Khi có người):</small>
                <div class="row g-2">
                    <div class="col-6"><button id="btn-ceil-on-auto" class="btn-control" onclick="sendCmd('ceil','1', 'auto')">BẬT TRẦN</button></div>
                    <div class="col-6"><button id="btn-ceil-off-auto" class="btn-control" onclick="sendCmd('ceil','0', 'auto')">TẮT TRẦN</button></div>
                </div>
            </div>

            <!-- Nút chỉnh Đèn trong Auto -->
            <div class="device-box">
                <small class="text-muted d-block mb-1 text-center fw-bold">Điều khiển Đèn (Khi có người):</small>
                <div class="row g-2">
                    <div class="col-6"><button id="btn-light-on-auto" class="btn-control" onclick="sendCmd('light','1', 'auto')">BẬT ĐÈN</button></div>
                    <div class="col-6"><button id="btn-light-off-auto" class="btn-control" onclick="sendCmd('light','0', 'auto')">TẮT ĐÈN</button></div>
                </div>
            </div>
        </div>

        <!-- PANEL MANUAL -->
        <div id="p-MANUAL" class="panel">
            <!-- 1. Quạt Trần -->
            <div class="device-box">
                <span class="device-title"><i class="fas fa-fan"></i> QUẠT TRẦN</span>
                <div class="row g-2">
                    <div class="col-6"><button id="btn-ceil-on" class="btn-control" onclick="sendCmd('ceil','1')">BẬT</button></div>
                    <div class="col-6"><button id="btn-ceil-off" class="btn-control" onclick="sendCmd('ceil','0')">TẮT</button></div>
                </div>
            </div>
            
            <!-- 2. Quạt Hút -->
            <div class="device-box">
                <span class="device-title"><i class="fas fa-wind"></i> QUẠT HÚT</span>
                <div class="row g-2">
                    <div class="col-6"><button id="btn-exh-on" class="btn-control" onclick="sendCmd('exh','1')">BẬT</button></div>
                    <div class="col-6"><button id="btn-exh-off" class="btn-control" onclick="sendCmd('exh','0')">TẮT</button></div>
                </div>
            </div>

            <!-- 3. Đèn -->
            <div class="device-box">
                <span class="device-title"><i class="fas fa-lightbulb"></i> ĐÈN ĐIỆN</span>
                <div class="row g-2">
                    <div class="col-6"><button id="btn-light-on" class="btn-control" onclick="sendCmd('light','1')">BẬT</button></div>
                    <div class="col-6"><button id="btn-light-off" class="btn-control" onclick="sendCmd('light','0')">TẮT</button></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const cfg = { host: "7e225cbc2f0c41febc61a20d1a0c5b3d.s1.eu.hivemq.cloud", port: 8884, user: "ngoctuyka", pass: "Tu12345678@", ssl: true };
    const pfx = "stem_thpt_physics_project_2025";
    const topics = {
        co2: pfx+"/data/co2", temp: pfx+"/data/temp", hum: pfx+"/data/hum", dust: pfx+"/data/dust", occ: pfx+"/data/occupancy",
        mode: pfx+"/control/mode", 
        cmd_ceil: pfx+"/control/fan_ceil", cmd_exh: pfx+"/control/fan_exh", cmd_light: pfx+"/control/light",
        st_ceil: pfx+"/status/ceil", st_exh: pfx+"/status/exh", st_light: pfx+"/status/light"
    };

    const client = new Paho.MQTT.Client(cfg.host, cfg.port, "Web-" + parseInt(Math.random()*1000));

    function setMode(m, btn) {
        document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show')); document.getElementById('p-'+m).classList.add('show');
        sendMQTT(topics.mode, (m==='AUTO')?"1":"0");
    }
    
    function sendCmd(dev, val, mode='manual') { 
        // Gửi lệnh MQTT
        if(dev==='ceil') sendMQTT(topics.cmd_ceil, val);
        if(dev==='exh') sendMQTT(topics.cmd_exh, val);
        if(dev==='light') sendMQTT(topics.cmd_light, val);

        // Cập nhật giao diện ngay lập tức (Optimistic UI) để người dùng thấy phản hồi
        updateBtnUI(dev, val, mode);
    }

    // Hàm cập nhật màu nút
    function updateBtnUI(dev, val, mode='manual') {
        // Xác định ID nút dựa trên thiết bị và chế độ
        let btnOn, btnOff;
        if (mode === 'manual') {
            btnOn = document.getElementById('btn-' + dev + '-on');
            btnOff = document.getElementById('btn-' + dev + '-off');
        } else {
            // Chế độ auto chỉ có nút cho trần và đèn
            btnOn = document.getElementById('btn-' + dev + '-on-auto');
            btnOff = document.getElementById('btn-' + dev + '-off-auto');
        }

        if (!btnOn || !btnOff) return; // Nếu không tìm thấy nút thì bỏ qua

        // Reset class cũ
        btnOn.className = 'btn-control';
        btnOff.className = 'btn-control';

        // Add class mới dựa trên giá trị val (1 hoặc 0)
        if (val === '1') {
            btnOn.classList.add('active-on');
        } else {
            btnOff.classList.add('active-off');
        }
    }

    function logout() { sessionStorage.removeItem('isLoggedIn'); window.location.href='login.html'; }
    function sendMQTT(t,m) { if(client.isConnected()) client.send(t,m,0,true); }

    client.onConnectionLost = (e)=>{ console.log("Lost"); document.getElementById('st-co2').innerText="Offline"; };
    client.onMessageArrived = (m)=>{
        const t = m.destinationName, p = m.payloadString;
        if(t===topics.co2) {
            let v=parseInt(p), c=(v>1000)?(v>2000?"#dc3545":"#ffc107"):"#20c997";
            document.getElementById('v-co2').innerText=v;
            document.getElementById('g-co2').style.background=`conic-gradient(${c} ${v/50}%, #eee 0%)`;
            document.getElementById('st-co2').innerText=(v>1000)?"Cảnh báo":"Tốt";
            document.getElementById('st-co2').style.color=c;
        }
        if(t===topics.temp) document.getElementById('v-temp').innerText=p;
        if(t===topics.hum) document.getElementById('v-hum').innerText=p;
        if(t===topics.dust) document.getElementById('v-dust').innerText=p;
        
        if(t===topics.occ) {
            let hasP = (p==="1");
            let c = document.getElementById('card-occ');
            if(hasP) { c.className="presence-card has-person"; document.getElementById('txt-occ').innerText="CÓ NGƯỜI"; } 
            else { c.className="presence-card no-person"; document.getElementById('txt-occ').innerText="VẮNG"; }
        }

        // Cập nhật trạng thái status và đồng bộ nút bấm từ MQTT
        if(t===topics.st_ceil) { updateStatus('st-ceil', p); updateBtnUI('ceil', p); updateBtnUI('ceil', p, 'auto'); }
        if(t===topics.st_exh) { updateStatus('st-exh', p); updateBtnUI('exh', p); }
        if(t===topics.st_light) { updateStatus('st-light', p); updateBtnUI('light', p); updateBtnUI('light', p, 'auto'); }
    };

    function updateStatus(id, val) {
        let el = document.getElementById(id);
        if(val==="1") { el.innerText="BẬT"; el.className="status-badge st-on"; }
        else { el.innerText="TẮT"; el.className="status-badge st-off"; }
    }

    client.connect({ onSuccess:()=>{ console.log("Connected"); document.getElementById('st-co2').innerText="Online"; Object.values(topics).forEach(t => client.subscribe(t)); }, useSSL:cfg.ssl, userName:cfg.user, password:cfg.pass });
</script>
</body>
</html>
