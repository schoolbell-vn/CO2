<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart STEM Monitor</title>
    <script>if(sessionStorage.getItem('isLoggedIn')!=='true')window.location.href='login.html';</script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { background: #f0f2f5; font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: #fff; }
        
        /* HEADER */
        .header { background: linear-gradient(135deg, #0061f2, #00ba94); padding: 20px 20px 40px; color: white; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; }
        
        /* GAUGE & SENSORS */
        .gauge-card { background: white; margin: -30px 15px 10px; border-radius: 20px; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; }
        .co2-circle { width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(#00ba94 0%, #eee 0%); margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; }
        .co2-inner { width: 100px; height: 100px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; }
        
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 15px; }
        .s-card { background: #f8f9fa; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .s-val { font-size: 1.2rem; font-weight: 800; color: #333; }

        /* PRESENCE CARD (Quan trọng) */
        .presence-card { margin: 10px 15px; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; }
        .is-present { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .no-present { background: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }

        /* CONTROLS */
        .control-area { padding: 15px; }
        .mode-sw { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .mode-btn { flex: 1; border: none; background: none; padding: 8px; border-radius: 8px; font-weight: 600; font-size: 13px; color: #666; }
        .mode-btn.active { background: white; color: #0061f2; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .btn-big { width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; margin-bottom: 8px; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-on { background: #ff4757; } .btn-off { background: #2f3542; } .btn-save { background: #0061f2; }
        
        .panel { display: none; } .panel.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(5px);} to {opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header d-flex justify-content-between align-items-center">
        <div><h5 class="m-0 fw-bold">Smart Classroom</h5><small>IoT Monitor System</small></div>
        <button onclick="logout()" class="btn btn-sm btn-light text-primary rounded-circle"><i class="fas fa-sign-out-alt"></i></button>
    </div>

    <div class="gauge-card">
        <div class="co2-circle" id="g-co2"><div class="co2-inner"><span id="v-co2" style="font-size:1.6rem; font-weight:bold">--</span><span style="font-size:0.7rem">PPM</span></div></div>
        <div id="st-co2" class="fw-bold text-success small">Đang tải...</div>
    </div>

    <div class="sensor-grid">
        <div class="s-card"><i class="fas fa-temperature-high text-danger"></i> <span id="v-temp" class="s-val">--</span>°C</div>
        <div class="s-card"><i class="fas fa-tint text-primary"></i> <span id="v-hum" class="s-val">--</span>%</div>
        <div class="s-card" style="grid-column: span 2;"><i class="fas fa-smog text-secondary"></i> Bụi PM2.5: <span id="v-dust" class="s-val">--</span> µg/m³</div>
    </div>

    <div class="presence-card no-present" id="card-occ">
        <div class="d-flex align-items-center gap-2">
            <i class="fas fa-user-friends fa-lg"></i>
            <strong>Trạng thái lớp:</strong>
        </div>
        <span id="txt-occ" class="badge bg-secondary">VẮNG</span>
    </div>

    <div class="control-area">
        <div class="mode-sw">
            <button class="mode-btn active" onclick="setMode('AUTO', this)">Tự động</button>
            <button class="mode-btn" onclick="setMode('MANUAL', this)">Thủ công</button>
            <button class="mode-btn" onclick="setMode('TIMER', this)">Hẹn giờ</button>
        </div>

        <div id="p-AUTO" class="panel show">
            <div class="alert alert-info border-0 small">
                <i class="fas fa-bolt me-1"></i> <strong>Tiết kiệm năng lượng:</strong><br>
                Nếu <b>không có người</b>, hệ thống sẽ tự động tắt hết Đèn và Quạt.
            </div>
            <div class="d-flex gap-2">
                <div class="w-50 bg-light p-2 rounded text-center small">Quạt: <b id="st-fan">--</b></div>
                <div class="w-50 bg-light p-2 rounded text-center small">Đèn: <b id="st-light">--</b></div>
            </div>
        </div>

        <div id="p-MANUAL" class="panel">
            <div class="row g-2">
                <div class="col-6"><button class="btn-big btn-on" onclick="sendCmd('fan','1')"><i class="fas fa-fan"></i> Bật Quạt</button></div>
                <div class="col-6"><button class="btn-big btn-off" onclick="sendCmd('fan','0')"><i class="fas fa-stop"></i> Tắt Quạt</button></div>
                <div class="col-6"><button class="btn-big btn-on" style="background:#f1c40f; color:#000" onclick="sendCmd('light','1')"><i class="fas fa-lightbulb"></i> Bật Đèn</button></div>
                <div class="col-6"><button class="btn-big btn-off" onclick="sendCmd('light','0')"><i class="fas fa-power-off"></i> Tắt Đèn</button></div>
            </div>
        </div>

        <div id="p-TIMER" class="panel">
            <div class="input-group mb-3">
                <span class="input-group-text">Bật</span><input type="time" id="t-on" class="form-control">
                <span class="input-group-text">Tắt</span><input type="time" id="t-off" class="form-control">
            </div>
            <button class="btn-big btn-save" onclick="sendTimer()">Lưu Hẹn Giờ (Quạt)</button>
        </div>
    </div>
</div>

<script>
    const cfg = { host: "7e225cbc2f0c41febc61a20d1a0c5b3d.s1.eu.hivemq.cloud", port: 8884, user: "ngoctuyka", pass: "Tu12345678@", ssl: true };
    const pfx = "stem_thpt_physics_project_2025";
    const topics = {
        co2: pfx+"/data/co2", temp: pfx+"/data/temp", hum: pfx+"/data/hum", dust: pfx+"/data/dust", occ: pfx+"/data/occupancy",
        mode: pfx+"/control/mode", fan: pfx+"/control/fan", light: pfx+"/control/light", timer: pfx+"/control/timer",
        fan_st: pfx+"/status/fan", light_st: pfx+"/status/light"
    };

    const client = new Paho.MQTT.Client(cfg.host, cfg.port, "Web-" + parseInt(Math.random()*1000));

    function setMode(m, btn) {
        document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show')); document.getElementById('p-'+m).classList.add('show');
        let val = (m==='AUTO')?"1":(m==='TIMER'?"2":"0");
        sendMQTT(topics.mode, val);
    }
    function sendCmd(dev, val) { sendMQTT(topics[dev], val); }
    function sendTimer() {
        let t1=document.getElementById('t-on').value, t2=document.getElementById('t-off').value;
        if(t1&&t2) { sendMQTT(topics.timer, t1+"|"+t2); alert("Đã lưu!"); }
    }
    function logout() { sessionStorage.removeItem('isLoggedIn'); window.location.href='login.html'; }
    function sendMQTT(t,m) { if(client.isConnected()) client.send(t,m,0,true); }

    client.onConnectionLost = (e)=>{ console.log("Lost"); document.getElementById('st-co2').innerText="Offline"; };
    client.onMessageArrived = (m)=>{
        const t = m.destinationName, p = m.payloadString;
        if(t===topics.co2) {
            let v=parseInt(p), c=(v>1000)?(v>2000?"#e74c3c":"#f1c40f"):"#00ba94";
            document.getElementById('v-co2').innerText=v;
            document.getElementById('g-co2').style.background=`conic-gradient(${c} ${v/50}%, #eee 0%)`;
            document.getElementById('st-co2').innerText=(v>1000)?"Khí kém":"Khí tốt";
            document.getElementById('st-co2').style.color=c;
        }
        if(t===topics.temp) document.getElementById('v-temp').innerText=p;
        if(t===topics.hum) document.getElementById('v-hum').innerText=p;
        if(t===topics.dust) document.getElementById('v-dust').innerText=p;
        if(t===topics.occ) { // XỬ LÝ GIAO DIỆN KHI CÓ NGƯỜI/KHÔNG NGƯỜI
            let hasP = (p==="1");
            let card = document.getElementById('card-occ');
            let txt = document.getElementById('txt-occ');
            if(hasP) {
                card.className = "presence-card is-present";
                txt.className = "badge bg-success";
                txt.innerText = "CÓ NGƯỜI";
            } else {
                card.className = "presence-card no-present";
                txt.className = "badge bg-secondary";
                txt.innerText = "VẮNG";
            }
        }
        if(t===topics.fan_st) document.getElementById('st-fan').innerText = (p==="1"?"BẬT":"TẮT");
        if(t===topics.light_st) document.getElementById('st-light').innerText = (p==="1"?"SÁNG":"TẮT");
    };

    client.connect({ onSuccess:()=>{ console.log("Connected"); document.getElementById('st-co2').innerText="Online"; Object.values(topics).forEach(t => client.subscribe(t)); }, useSSL:cfg.ssl, userName:cfg.user, password:cfg.pass });
</script>
</body>
</html>
