<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hệ Thống Lớp Học Thông Minh</title>
    <script>if(sessionStorage.getItem('isLoggedIn')!=='true')window.location.href='login.html';</script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; padding-bottom: 100px; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .header { background: linear-gradient(135deg, #0d6efd, #0dcaf0); padding: 25px 20px 50px; color: white; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; }
        
        .gauge-card { background: white; margin: -40px 20px 15px; border-radius: 25px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); text-align: center; }
        .co2-circle { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(#eee 100%, #eee 0%); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; transition: background 0.5s ease; }
        .co2-inner { width: 115px; height: 115px; background: white; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; }
        
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px; }
        .s-card { background: #f8f9fa; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #edf2f7; }
        .s-val { font-size: 1.4rem; font-weight: 800; color: #2d3436; display: block; margin-top: 5px; }

        .presence-card { margin: 15px 20px; padding: 15px 20px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s; }
        .is-present { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .no-present { background: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }
        
        .control-area { padding: 20px; background: white; border-top-left-radius: 30px; border-top-right-radius: 30px; margin-top: 10px; }
        .mode-sw { display: flex; background: #f1f3f5; border-radius: 15px; padding: 5px; margin-bottom: 20px; }
        .mode-btn { flex: 1; border: none; background: none; padding: 10px; border-radius: 12px; font-weight: 600; color: #868e96; }
        .mode-btn.active { background: white; color: #0d6efd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .btn-big { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; margin-bottom: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; opacity: 0.6; transition: 0.3s; filter: grayscale(100%); }
        
        /* Trạng thái nút khi được kích hoạt */
        .btn-active-on { opacity: 1 !important; filter: grayscale(0%) !important; background: linear-gradient(45deg, #ff6b6b, #ee5253); box-shadow: 0 4px 15px rgba(238, 82, 83, 0.4); transform: scale(1.02); }
        .btn-active-off { opacity: 1 !important; filter: grayscale(0%) !important; background: #2d3436; box-shadow: 0 4px 15px rgba(45, 52, 54, 0.4); transform: scale(1.02); }
        .btn-active-light { opacity: 1 !important; filter: grayscale(0%) !important; background: linear-gradient(45deg, #f1c40f, #f39c12); color: #fff; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.4); transform: scale(1.02); }
        
        /* Màu mặc định của nút */
        .btn-def-on { background: #ff6b6b; } 
        .btn-def-off { background: #2d3436; }
        .btn-def-light { background: #f1c40f; }
        
        .panel { display: none; } .panel.show { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header d-flex justify-content-between align-items-center">
        <div>
            <h5 class="m-0"><i class="fas fa-graduation-cap me-2"></i>Smart Classroom</h5>
            <small id="connection-status"><span class="status-dot"></span>Đang kết nối...</small>
        </div>
        <button onclick="logout()" class="btn btn-sm btn-light text-primary rounded-circle"><i class="fas fa-sign-out-alt"></i></button>
    </div>

    <div class="gauge-card">
        <div class="co2-circle" id="g-co2">
            <div class="co2-inner">
                <span id="v-co2" style="font-size:2rem; font-weight:800; color:#333; line-height: 1;">--</span>
                <span style="font-size:0.75rem; color:#888; font-weight:600">PPM</span>
            </div>
        </div>
        <div id="st-co2" class="fw-bold small badge bg-secondary px-3 py-2 rounded-pill">Đang tải dữ liệu...</div>
    </div>

    <div class="sensor-grid">
        <div class="s-card">
            <i class="fas fa-temperature-high text-danger mb-2"></i><br>Nhiệt độ
            <span id="v-temp" class="s-val">--°C</span>
        </div>
        <div class="s-card">
            <i class="fas fa-tint text-primary mb-2"></i><br>Độ ẩm
            <span id="v-hum" class="s-val">--%</span>
        </div>
        <div class="s-card" style="grid-column: span 2; display: flex; align-items: center; justify-content: space-between; padding: 15px 25px;">
            <div><i class="fas fa-smog text-secondary mb-1"></i> Bụi PM2.5</div>
            <span id="v-dust" class="s-val" style="margin:0; font-size: 1.6rem;">-- <small style="font-size:0.9rem; color:#888">µg/m³</small></span>
        </div>
    </div>

    <div class="presence-card no-present" id="card-occ">
        <div class="d-flex align-items-center gap-3">
            <i class="fas fa-user-friends fa-2x"></i>
            <div style="line-height: 1.2;">
                <strong>Cảm biến người</strong><br>
                <small id="lbl-occ-desc">Không phát hiện</small>
            </div>
        </div>
        <span id="txt-occ" class="badge bg-secondary rounded-pill px-3">VẮNG</span>
    </div>

    <div class="control-area">
        <div class="mode-sw">
            <button class="mode-btn active" onclick="setMode('AUTO', this)">Tự động</button>
            <button class="mode-btn" onclick="setMode('MANUAL', this)">Thủ công</button>
            <button class="mode-btn" onclick="setMode('TIMER', this)">Hẹn giờ</button>
        </div>

        <div id="p-AUTO" class="panel show">
            <div class="alert alert-primary border-0 small shadow-sm">
                <i class="fas fa-robot me-2"></i> <strong>Chế độ thông minh:</strong><br>
                Hệ thống tự động BẬT khi có người và TẮT sau khi vắng người (60s).
            </div>
            <div class="d-flex gap-2 mt-3">
                <div class="w-50 bg-light p-3 rounded-4 text-center border">
                    <small class="text-muted d-block mb-1">TRẠNG THÁI QUẠT</small>
                    <b id="st-fan-auto" class="text-primary">--</b>
                </div>
                <div class="w-50 bg-light p-3 rounded-4 text-center border">
                    <small class="text-muted d-block mb-1">TRẠNG THÁI ĐÈN</small>
                    <b id="st-light-auto" class="text-warning">--</b>
                </div>
            </div>
        </div>

        <div id="p-MANUAL" class="panel">
            <div class="alert alert-warning border-0 small shadow-sm mb-3">
                <i class="fas fa-hand-pointer me-2"></i> <strong>Chế độ Thủ công:</strong><br>
                Bạn có toàn quyền kiểm soát. Các cảm biến sẽ không tự động tắt thiết bị.
            </div>
            <div class="row g-2">
                <div class="col-6"><button id="btn-fan-on" class="btn-big btn-def-on" onclick="sendCmd('fan_ceil','1')"><i class="fas fa-fan"></i> Bật Quạt</button></div>
                <div class="col-6"><button id="btn-fan-off" class="btn-big btn-def-off" onclick="sendCmd('fan_ceil','0')"><i class="fas fa-ban"></i> Tắt Quạt</button></div>
                
                <div class="col-6"><button id="btn-light-on" class="btn-big btn-def-light" onclick="sendCmd('light','1')"><i class="fas fa-lightbulb"></i> Bật Đèn</button></div>
                <div class="col-6"><button id="btn-light-off" class="btn-big btn-def-off" onclick="sendCmd('light','0')"><i class="fas fa-power-off"></i> Tắt Đèn</button></div>
                
                <div class="col-12 mt-2"><button id="btn-exh-off" class="btn-big btn-def-off" onclick="sendCmd('fan_exh','0')"><i class="fas fa-wind"></i> Tắt Quạt Hút (Cưỡng bức)</button></div>
            </div>
        </div>

        <div id="p-TIMER" class="panel">
            <div class="input-group mb-3">
                <span class="input-group-text">Bật</span><input type="time" id="t-on" class="form-control">
                <span class="input-group-text">Tắt</span><input type="time" id="t-off" class="form-control">
            </div>
            <button class="btn-big btn-save" onclick="sendTimer()">Lưu Hẹn Giờ</button>
        </div>
    </div>
</div>

<script>
    const cfg = { host: "7e225cbc2f0c41febc61a20d1a0c5b3d.s1.eu.hivemq.cloud", port: 8884, user: "ngoctuyka", pass: "Tu12345678@", ssl: true };
    const pfx = "stem_thpt_physics_project_2025";
    const topics = {
        co2: pfx+"/data/co2", temp: pfx+"/data/temp", hum: pfx+"/data/hum", dust: pfx+"/data/dust", occ: pfx+"/data/occupancy",
        mode: pfx+"/control/mode", fan_ceil: pfx+"/control/fan_ceil", fan_exh: pfx+"/control/fan_exh", light: pfx+"/control/light", timer: pfx+"/control/timer",
        st_ceil: pfx+"/status/ceil", st_light: pfx+"/status/light", st_exh: pfx+"/status/exh"
    };

    const client = new Paho.MQTT.Client(cfg.host, cfg.port, "Web-" + parseInt(Math.random()*10000));

    function setMode(m, btn) {
        document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('show')); document.getElementById('p-'+m).classList.add('show');
        
        // Gửi lệnh chuyển chế độ ngay khi bấm Tab
        let val = (m==='AUTO')?"1":(m==='TIMER'?"2":"0");
        sendMQTT(topics.mode, val);
    }
    
    function sendCmd(dev, val) { 
        sendMQTT(topics[dev], val); 
        // Hiệu ứng rung nhẹ khi bấm để biết đã nhận
        if(window.navigator && window.navigator.vibrate) navigator.vibrate(50);
    }
    
    function sendTimer() {
        let t1=document.getElementById('t-on').value, t2=document.getElementById('t-off').value;
        if(t1&&t2) { sendMQTT(topics.timer, t1+"|"+t2); alert("Đã lưu!"); }
    }
    function logout() { sessionStorage.removeItem('isLoggedIn'); window.location.href='login.html'; }
    function sendMQTT(t,m) { if(client.isConnected()) client.send(t,m,0,true); }

    client.onConnectionLost = (e)=>{ document.getElementById('connection-status').innerHTML = "<span class='status-dot' style='background:red'></span>Mất kết nối"; };
    client.onMessageArrived = (m)=>{
        const t = m.destinationName, p = m.payloadString;
        
        const updateVal = (id, val, suffix) => {
            const el = document.getElementById(id);
            if(val === "ERR") { el.innerText = "Lỗi"; el.style.color = "red"; el.style.fontSize="1rem"; }
            else { el.innerText = val + suffix; el.style.color = "#2d3436"; el.style.fontSize="1.4rem"; }
        };

        if(t===topics.temp) updateVal('v-temp', p, '°C');
        if(t===topics.hum) updateVal('v-hum', p, '%');
        if(t===topics.dust) updateVal('v-dust', p, '');
        
        if(t===topics.co2) {
            if (p === "ERR") {
                document.getElementById('v-co2').innerText = "Lỗi"; document.getElementById('v-co2').style.color="red";
                document.getElementById('st-co2').innerText = "Kiểm tra cảm biến"; document.getElementById('st-co2').className="badge bg-danger rounded-pill";
            } else {
                let v = parseInt(p);
                let c = (v>1000)?(v>2000?"#e74c3c":"#f1c40f"):"#2ecc71";
                document.getElementById('v-co2').innerText = v; document.getElementById('v-co2').style.color="#333";
                document.getElementById('g-co2').style.background = `conic-gradient(${c} ${Math.min((v/2000)*100,100)}%, #eee 0%)`;
                document.getElementById('st-co2').innerText = (v>1000)?"Không khí kém":"Không khí tốt";
                document.getElementById('st-co2').className = `badge rounded-pill ${v>1000?'bg-warning text-dark':'bg-success'}`;
            }
        }
        if(t===topics.occ) {
            let hasP = (p==="1");
            let card = document.getElementById('card-occ');
            if(hasP) {
                card.className = "presence-card is-present pulse";
                document.getElementById('txt-occ').innerText = "CÓ NGƯỜI"; document.getElementById('txt-occ').className="badge bg-success rounded-pill";
            } else {
                card.className = "presence-card no-present";
                document.getElementById('txt-occ').innerText = "VẮNG"; document.getElementById('txt-occ').className="badge bg-secondary rounded-pill";
            }
        }
        
        // --- CẬP NHẬT TRẠNG THÁI NÚT BẤM (PHẦN MỚI) ---
        if(t===topics.st_ceil) {
            document.getElementById('st-fan-auto').innerText = (p==="1"?"ĐANG QUAY":"ĐÃ TẮT");
            if(p==="1") {
                document.getElementById('btn-fan-on').classList.add('btn-active-on');
                document.getElementById('btn-fan-off').classList.remove('btn-active-off');
            } else {
                document.getElementById('btn-fan-on').classList.remove('btn-active-on');
                document.getElementById('btn-fan-off').classList.add('btn-active-off');
            }
        }
        if(t===topics.st_light) {
            document.getElementById('st-light-auto').innerText = (p==="1"?"ĐANG SÁNG":"ĐÃ TẮT");
            if(p==="1") {
                document.getElementById('btn-light-on').classList.add('btn-active-light');
                document.getElementById('btn-light-off').classList.remove('btn-active-off');
            } else {
                document.getElementById('btn-light-on').classList.remove('btn-active-light');
                document.getElementById('btn-light-off').classList.add('btn-active-off');
            }
        }
    };

    client.connect({ onSuccess:()=>{ document.getElementById('connection-status').innerHTML = "<span class='status-dot online'></span>Đã kết nối"; Object.values(topics).forEach(t => client.subscribe(t)); }, useSSL:cfg.ssl, userName:cfg.user, password:cfg.pass });
</script>
</body>
</html>
